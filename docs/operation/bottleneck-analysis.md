# 시스템 병목 지점 분석

**작성일**: 2026-01-06

---

## 🔴 CRITICAL: 대기열 활성화 타임아웃

**현상**: WAITING → ACTIVE 상태 전환 미작동
**영향**: 전체 예약/결제 플로우 차단
**원인**: 스케줄러 미실행 또는 Redis Lua 스크립트 오류

**해결 방안**
```kotlin
// QueueScheduler.kt 점검
@Scheduled(fixedDelay = 10000)
fun activateWaitingTokens() {
    // 로그 추가 및 Redis 연산 검증 필요
}
```

---

## ⚠️ 주요 병목 지점

### 1. 대기열 처리 속도
```kotlin
MAX_ACTIVE_USERS = 100          // → 1,000으로 증가
BATCH_ACTIVATION_SIZE = 10      // → 100으로 증가
```
**현재**: 10,000명 대기 시 2시간 47분 소요
**개선 후**: 15~20분으로 단축

### 2. DB 커넥션 풀
```yaml
hikari:
  maximum-pool-size: 20  # → 50으로 증가
```
**현재**: 동시 100명 시 부족 가능
**개선 후**: 동시 1,000명 처리 가능

### 3. Redis 분산락
```kotlin
// 타임아웃 단축
wait: 3초 → 1초
lease: 5초 → 3초
```

### 4. Kafka Consumer
```yaml
# 파티션 증가로 병렬 처리
reservation.confirmed: 1개 → 3개
```

---

## 📊 성능 한계 (부하 테스트 결과)

| 항목 | 현재 | 목표 (1주) | 목표 (3개월) |
|------|------|-----------|-------------|
| 동시 활성 사용자 | 100명 | 1,000명 | 10,000명 |
| 초당 처리량 | 2,081 req/sec | 20,000 req/sec | 50,000 req/sec |
| API 응답 (P95) | 6.82ms | < 50ms | < 100ms |

---

## 🎯 개선 우선순위

### 즉시 (1주 이내)
1. 대기열 스케줄러 수정 (CRITICAL)
2. DB 커넥션 풀: 20 → 50
3. 대기열 설정: MAX_ACTIVE_USERS 1,000

### 중기 (1개월 이내)
4. Kafka 파티션: 1 → 3
5. 캐시 TTL: 10초 → 30초
6. 분산락 타임아웃 단축

### 장기 (3개월 이내)
7. Redis Cluster 구성
8. 애플리케이션 서버: 3대 → 10대
9. APM 도구 도입

---

## 📈 모니터링 알람 임계값

| 지표 | Warning | Critical |
|------|---------|----------|
| HTTP 에러율 | 1% | 5% |
| DB 커넥션 사용률 | 70% | 90% |
| Consumer Lag | 1,000건 | 10,000건 |
| Redis 메모리 | 70% | 90% |
| 대기 시간 | 10분 | 30분 |
