# 시나리오 3: 동시 결제 처리 테스트

**테스트 일시**: 2026-01-06
**테스트 조건**: 10 VUs (사전 준비) + 50 req/sec (결제), 1분 30초

---

## 테스트 목적

초당 1,000건 동시 결제 처리 (테스트용 50 req/sec로 축소)
- 포인트 차감 정합성 검증
- DB 데드락 및 트랜잭션 충돌 모니터링

---

## 핵심 결과

### ✅ 측정 성공

| 지표 | 결과 | 평가 |
|------|------|------|
| **포인트 충전 성공률** | **100%** (50/50) | ✅ 완벽 |
| **DB 데드락** | **0건** | ✅ 안정적 |
| **P95 응답시간** | **96.42ms** | ✅ 양호 |
| **평균 응답시간** | **15.77ms** | ✅ 빠름 |

### ❌ 차단 이슈

**결제 단계 미측정** (k6 스크립트 데이터 공유 문제)
- `setup_reservations`와 `concurrent_payment` 시나리오 간 변수 공유 불가
- 예약 ID를 결제 단계로 전달 불가
- 결제 테스트 0건 처리

**HTTP 실패율 33.33%**
- 총 150 요청 중 50건 실패 (예약 생성 단계)
- 대기열 활성화 타임아웃 또는 좌석 중복 예약으로 추정

---

## 상세 메트릭

```
총 HTTP 요청: 150건
총 반복 횟수: 1,550

응답 시간:
  - 평균: 15.77ms
  - P90: 35.17ms
  - P95: 96.42ms
  - Max: 131.86ms

성공한 요청 (포인트 충전):
  - 평균: 22.34ms
  - P95: 109.19ms

처리량: 1.67 req/sec
```

---

## 측정 가능했던 성능

### 1. 포인트 충전
- 성공률: **100%** (50/50)
- 평균 응답 시간: ~22ms
- DB 트랜잭션 정합성 유지

### 2. DB 안정성
- 데드락: **0건**
- 커넥션 풀 고갈: 없음
- 시스템 크래시: 없음

---

## 측정하지 못한 항목

- ❌ 실제 결제 처리 성능
- ❌ 결제 트랜잭션 응답 시간
- ❌ 동시 결제 시 DB 데드락 발생률
- ❌ 포인트 차감 정합성 (동시 차감)

---

## 개선 방안

### k6 스크립트 리팩토링

**옵션 1: 단일 시나리오로 통합**
```javascript
export default function() {
  // 1. 토큰 발급
  // 2. 포인트 충전
  // 3. 예약 생성
  // 4. 즉시 결제 (같은 iteration 내)
}
```

**옵션 2: 사전 데이터 준비**
- DB에 미리 예약 데이터 삽입
- 테스트 스크립트는 결제만 수행

---

## 다음 단계

**즉시 조치**:
1. k6 스크립트 재설계 (단일 시나리오 또는 SharedArray 사용)
2. 대기열 활성화 로직 수정

**이슈 해결 후**:
- 초당 50~1,000건 결제 처리 측정
- DB 데드락 발생률 측정
- HikariCP 커넥션 풀 사용률 모니터링

---

**보고서 작성**: 2026-01-06
**상태**: ⚠️ 부분 성공 (포인트 충전만 측정)
